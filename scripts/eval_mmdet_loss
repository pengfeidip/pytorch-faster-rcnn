#! /usr/bin/env python

import os, sys, glob, easy
import os.path as osp

def get_loss(line, token):
    idx = line.find(token)
    end = line.find(',', idx)
    piece = line[idx+len(token):end].strip(': ,')
    return float(piece)

def get_epoch(line):
    idx = line.find('Epoch')
    start = line.find('[', idx)
    end = line.find(']', idx)
    return line[start+1:end]

def parse_line(line):
    epoch = get_epoch(line)
    loss = get_loss(line, 'loss:')
    print(epoch, loss)

LOSSES = ['loss_rpn_cls', 'loss_rpn_bbox', 's0.loss_cls', 's0.loss_bbox', 's1.loss_cls', 's1.loss_bbox',
          's2.loss_cls', 's2.loss_bbox', 'loss:']

def avg(lst):
    return round(sum(lst)/len(lst), 4)

if __name__ == '__main__':
    log = sys.argv[1]
    epoch2_res = []
    for line in open(log):
        epoch = get_epoch(line)
        if epoch != '2':
            continue
        epoch2_res.append([get_loss(line, loss) for loss in LOSSES])
#    print(easy.tab2str(epoch2_res))
    print(easy.join('\t', [avg([row[i] for row in epoch2_res]) for i, loss in enumerate(LOSSES)]))
    print(easy.join('\t', LOSSES))
    
    
